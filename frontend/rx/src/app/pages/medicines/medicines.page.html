<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Medicine Database</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleViewMode()">
        <ion-icon [name]="viewMode === 'list' ? 'grid-outline' : 'list-outline'"></ion-icon>
      </ion-button>
      <ion-button (click)="exportMedicines()">
        <ion-icon name="download-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Statistics Cards -->
  <div class="stats-cards">
    <ion-grid>
      <ion-row>
        <ion-col size="6" size-md="3">
          <ion-card class="stat-card" color="primary">
            <ion-card-content>
              <h2>{{stats.total}}</h2>
              <p>Total Medicines</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="6" size-md="3">
          <ion-card class="stat-card" color="success">
            <ion-card-content>
              <h2>{{stats.active}}</h2>
              <p>Active</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="6" size-md="3">
          <ion-card class="stat-card" color="warning">
            <ion-card-content>
              <h2>{{stats.schedule_h}}</h2>
              <p>Schedule H</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="6" size-md="3">
          <ion-card class="stat-card" color="danger">
            <ion-card-content>
              <h2>{{stats.schedule_x}}</h2>
              <p>Schedule X</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Search and Filter Bar -->
  <div class="search-filter-bar">
    <ion-searchbar 
      placeholder="Search medicines by name, generic, or brand..."
      [value]="searchTerm"
      (ionInput)="searchMedicines($event)"
      animated
      clear-icon="close-circle"
      class="medicine-searchbar">
    </ion-searchbar>

    <div class="filter-controls">
      <ion-button fill="outline" color="medium" (click)="clearFilters()" *ngIf="getFilterCount() > 0 || searchTerm">
        <ion-icon name="close-circle-outline" slot="start"></ion-icon>
        Clear Filters
      </ion-button>

      <ion-select 
        [(ngModel)]="sortBy" 
        (ionChange)="applyFilters()"
        interface="action-sheet"
        placeholder="Sort by"
        class="sort-select">
        <ion-select-option *ngFor="let option of sortOptions" [value]="option.value">
          {{option.label}}
        </ion-select-option>
      </ion-select>
    </div>
  </div>

  <!-- Quick Filter Chips -->
  <div class="filter-chips" *ngIf="medicineForms.length > 0">
    <div class="filter-section">
      <h4>Form</h4>
      <div class="chips-container">
        <ion-chip [outline]="activeFilters.form !== 'all'" [color]="activeFilters.form === 'all' ? 'primary' : 'medium'" (click)="activeFilters.form = 'all'; applyFilters()">
          All Forms
        </ion-chip>
        <ion-chip *ngFor="let form of medicineForms" 
          [outline]="activeFilters.form !== form" 
          [color]="activeFilters.form === form ? 'primary' : 'medium'"
          (click)="activeFilters.form = form; applyFilters()">
          <ion-icon [name]="getMedicineFormIcon(form)" slot="start"></ion-icon>
          {{form}}
        </ion-chip>
      </div>
    </div>

    <div class="filter-section" *ngIf="schedules.length > 0">
      <h4>Schedule</h4>
      <div class="chips-container">
        <ion-chip [outline]="activeFilters.schedule !== 'all'" [color]="activeFilters.schedule === 'all' ? 'primary' : 'medium'" (click)="activeFilters.schedule = 'all'; applyFilters()">
          All Schedules
        </ion-chip>
        <ion-chip *ngFor="let schedule of schedules" 
          [outline]="activeFilters.schedule !== schedule" 
          [color]="activeFilters.schedule === schedule ? getScheduleColor(schedule) : 'medium'"
          (click)="activeFilters.schedule = schedule; applyFilters()">
          {{getScheduleLabel(schedule)}}
        </ion-chip>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="4">
          <ion-button expand="block" color="primary" (click)="addMedicine()">
            <ion-icon name="add-outline" slot="start"></ion-icon>
            Add New Medicine
          </ion-button>
        </ion-col>
        <ion-col size="12" size-md="4">
          <ion-button expand="block" color="success" (click)="searchExternalMedicines()">
            <ion-icon name="search-outline" slot="start"></ion-icon>
            Search External DB
          </ion-button>
        </ion-col>
        <ion-col size="12" size-md="4">
          <ion-button expand="block" color="warning" (click)="bulkImportMedicines()">
            <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
            Bulk Import
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-section">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading medicines...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && filteredMedicines.length === 0" class="empty-state">
    <ion-icon name="medical-outline"></ion-icon>
    <h3>No Medicines Found</h3>
    <p *ngIf="searchTerm || getFilterCount() > 0">
      Try adjusting your search or filters
    </p>
    <p *ngIf="!searchTerm && getFilterCount() === 0">
      Your medicine database is empty
    </p>
    <div class="empty-state-actions">
      <ion-button color="primary" (click)="addMedicine()">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Add First Medicine
      </ion-button>
      <ion-button color="success" (click)="searchExternalMedicines()">
        <ion-icon name="search-outline" slot="start"></ion-icon>
        Search External Database
      </ion-button>
    </div>
  </div>

  <!-- List View -->
  <div *ngIf="!isLoading && viewMode === 'list' && filteredMedicines.length > 0">
    <ion-list class="medicines-list">
      <ion-item-sliding *ngFor="let medicine of filteredMedicines">
        <ion-item 
          class="medicine-item"
          [class.inactive]="!medicine.is_active">
          
          <ion-avatar slot="start">
            <div class="medicine-avatar" [class]="medicine.form?.toLowerCase()">
              <ion-icon [name]="getMedicineFormIcon(medicine.form)"></ion-icon>
            </div>
          </ion-avatar>
          
          <ion-label>
            <h2>
              {{medicine.name}}
              <ion-badge [color]="getScheduleColor(medicine.schedule)" class="schedule-badge">
                {{medicine.schedule || 'N/A'}}
              </ion-badge>
              <ion-badge [color]="medicine.is_active ? 'success' : 'danger'" class="status-badge">
                {{medicine.is_active ? 'Active' : 'Inactive'}}
              </ion-badge>
            </h2>
            
            <p class="generic-name" *ngIf="medicine.generic_name">
              <ion-icon name="flask-outline"></ion-icon>
              {{medicine.generic_name}}
            </p>
            
            <p class="medicine-details">
              <span class="strength">
                <ion-icon name="barbell-outline"></ion-icon>
                {{medicine.strength || 'N/A'}}
              </span>
              <span class="form">
                <ion-icon name="cube-outline"></ion-icon>
                {{medicine.form || 'N/A'}}
              </span>
              <span class="manufacturer" *ngIf="medicine.manufacturer">
                <ion-icon name="business-outline"></ion-icon>
                {{medicine.manufacturer}}
              </span>
            </p>
            
            <div class="medicine-meta">
              <span class="usage-count" *ngIf="medicine.usage_count">
                <ion-icon name="stats-chart-outline"></ion-icon>
                Used {{medicine.usage_count}} times
              </span>
              <span class="created-date">
                <ion-icon name="calendar-outline"></ion-icon>
                Added {{medicine.created_at | date:'mediumDate'}}
              </span>
            </div>
          </ion-label>
          
          <ion-note slot="end" class="medicine-brand" *ngIf="medicine.brand">
            {{medicine.brand}}
          </ion-note>
        </ion-item>

        <ion-item-options side="end">
          <ion-item-option color="warning" (click)="editMedicine(medicine)">
            <ion-icon slot="top" name="create-outline"></ion-icon>
            Edit
          </ion-item-option>
          <ion-item-option [color]="medicine.is_active ? 'medium' : 'success'" (click)="toggleMedicineStatus(medicine)">
            <ion-icon slot="top" [name]="medicine.is_active ? 'pause-outline' : 'play-outline'"></ion-icon>
            {{medicine.is_active ? 'Deactivate' : 'Activate'}}
          </ion-item-option>
          <ion-item-option color="danger" (click)="deleteMedicine(medicine)">
            <ion-icon slot="top" name="trash-outline"></ion-icon>
            Delete
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>
  </div>

  <!-- Grid View -->
  <div *ngIf="!isLoading && viewMode === 'grid' && filteredMedicines.length > 0" class="medicines-grid">
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6" size-lg="4" *ngFor="let medicine of filteredMedicines">
          <ion-card 
            class="medicine-card"
            [class.inactive]="!medicine.is_active">
            
            <div class="card-header">
              <div class="medicine-icon">
                <ion-icon [name]="getMedicineFormIcon(medicine.form)"></ion-icon>
              </div>
              <div class="header-content">
                <h3>{{medicine.name}}</h3>
                <p class="generic-name" *ngIf="medicine.generic_name">
                  {{medicine.generic_name}}
                </p>
              </div>
              <div class="header-badges">
                <ion-badge [color]="getScheduleColor(medicine.schedule)" class="schedule-badge">
                  {{medicine.schedule || 'N/A'}}
                </ion-badge>
                <ion-badge [color]="medicine.is_active ? 'success' : 'danger'" class="status-badge">
                  {{medicine.is_active ? 'Active' : 'Inactive'}}
                </ion-badge>
              </div>
            </div>

            <ion-card-content>
              <div class="medicine-content">
                <div class="details-section">
                  <div class="detail-item">
                    <ion-icon name="barbell-outline"></ion-icon>
                    <span><strong>Strength:</strong> {{medicine.strength || 'N/A'}}</span>
                  </div>
                  
                  <div class="detail-item">
                    <ion-icon name="cube-outline"></ion-icon>
                    <span><strong>Form:</strong> {{medicine.form || 'N/A'}}</span>
                  </div>
                  
                  <div class="detail-item" *ngIf="medicine.manufacturer">
                    <ion-icon name="business-outline"></ion-icon>
                    <span><strong>Manufacturer:</strong> {{medicine.manufacturer}}</span>
                  </div>
                  
                  <div class="detail-item" *ngIf="medicine.brand">
                    <ion-icon name="pricetag-outline"></ion-icon>
                    <span><strong>Brand:</strong> {{medicine.brand}}</span>
                  </div>
                </div>
                
                <div class="usage-section" *ngIf="medicine.usage_count">
                  <ion-progress-bar 
                    [value]="Math.min(medicine.usage_count / 100, 1)" 
                    color="primary">
                  </ion-progress-bar>
                  <p class="usage-count">Used {{medicine.usage_count}} times</p>
                </div>
              </div>

              <div class="card-footer">
                <div class="created-date">
                  Added {{medicine.created_at | date:'shortDate'}}
                </div>
                
                <div class="card-actions">
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    color="warning"
                    (click)="editMedicine(medicine)">
                    <ion-icon name="create-outline"></ion-icon>
                  </ion-button>
                  
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    [color]="medicine.is_active ? 'medium' : 'success'"
                    (click)="toggleMedicineStatus(medicine)">
                    <ion-icon [name]="medicine.is_active ? 'pause-outline' : 'play-outline'"></ion-icon>
                  </ion-button>
                  
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    color="danger"
                    (click)="deleteMedicine(medicine)">
                    <ion-icon name="trash-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Pagination Info -->
  <div *ngIf="!isLoading && filteredMedicines.length > 0" class="pagination-info">
    <p>Showing {{filteredMedicines.length}} of {{medicines.length}} medicines</p>
  </div>

  <!-- Refresh Content -->
  <ion-refresher slot="fixed" (ionRefresh)="refreshData($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
</ion-content>